<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="header">
        <!-- Logo -->
        <div class="logo"><img src="images/Logo_TIAW.jpg" /><a href="index.html">FocusTime</a></div>
    </header>

    <div class="body">
        <div class="container">
            <form id="registrationForm">
                <div class="photo-upload">
                    <div class="photo-preview-container">
                        <img id="photoPreview" alt="Pré-visualização da foto">
                        <div class="photo-placeholder" id="photoPlaceholder">
                            <img src="images/Usuario.png">
                        </div>
                    </div>

                    <div class="photo-actions" id="photoActions">
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-primary"
                            onclick="document.getElementById('photoInput').click()">Adicionar Foto</button>
                    </div>

                    <div class="edit-tools" id="editTools">
                        <button type="button" class="btn btn-secondary" id="editPhotoBtn">Editar Foto</button>
                        <button type="button" class="btn btn-secondary" id="removePhotoBtn">Remover Foto</button>
                    </div>

                    <div class="slider-container" id="brightnessSlider" style="display: none;">
                        <label for="brightness">Brilho</label>
                        <input type="range" id="brightness" class="slider_cadastro" min="0" max="200" value="100">
                    </div>

                    <div class="slider-container" id="contrastSlider" style="display: none;">
                        <label for="contrast">Contraste</label>
                        <input type="range" id="contrast" class="slider_cadastro" min="0" max="200" value="100">
                    </div>
                </div>

                <div class="name-fields">
                    <div class="form-group">
                        <label for="firstName">Primeiro Nome</label>
                        <input type="text" id="firstName" required>
                        <div class="error-message" id="firstNameError"></div>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Sobrenome</label>
                        <input type="text" id="lastName" required>
                        <div class="error-message" id="lastNameError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="age">Idade</label>
                    <input type="number" id="age" min="1" required>
                    <div class="error-message" id="ageError"></div>
                </div>

                <div class="form-group">
                    <label for="cpf">CPF</label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" required>
                    <div class="error-message" id="cpfError"></div>
                </div>

                <div class="form-group">
                    <label for="phone">Telefone com DDD</label>
                    <input type="tel" id="phone" placeholder="(00) 00000-0000" required>
                    <div class="error-message" id="phoneError"></div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                    <div class="error-message" id="emailError"></div>
                </div>

                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                    <div class="error-message" id="passwordError"></div>
                </div>

                <button type="submit" class="btn btn-primary submit-btn">Cadastrar</button>
            </form>
        </div>
    </div>

    <!-- Modal de edição de foto -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3 style="text-align: center; margin-bottom: 15px;">Editar Foto</h3>
            <canvas id="canvas"></canvas>
            <div class="modal-tools">
                <button type="button" class="btn btn-secondary" id="rotateLeftBtn">↺ Girar Esquerda</button>
                <button type="button" class="btn btn-secondary" id="rotateRightBtn">↻ Girar Direita</button>
                <button type="button" class="btn btn-primary" id="cropBtn">Recortar</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Salvar</button>
                <button type="button" class="btn btn-secondary" id="cancelEditBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        const photoPlaceholder = document.getElementById('photoPlaceholder');
        const photoActions = document.getElementById('photoActions');
        const editTools = document.getElementById('editTools');
        const editPhotoBtn = document.getElementById('editPhotoBtn');
        const removePhotoBtn = document.getElementById('removePhotoBtn');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const contrastSlider = document.getElementById('contrastSlider');
        const brightnessInput = document.getElementById('brightness');
        const contrastInput = document.getElementById('contrast');
        const successMessage = document.getElementById('successMessage');

        // Elementos do modal de edição
        const editModal = document.getElementById('editModal');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const cropBtn = document.getElementById('cropBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        // Variáveis de estado
        let currentImage = null;
        let rotation = 0;
        let isCropping = false;
        let cropStartX, cropStartY, cropEndX, cropEndY;
        let originalImageData = null;

        // Manipulação da foto de perfil
        photoInput.addEventListener('change', function (e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = function (event) {
                    currentImage = new Image();
                    currentImage.onload = function () {
                        showImage(this);
                        editTools.style.display = 'flex';
                        photoActions.style.display = 'none';
                        brightnessSlider.style.display = 'none';
                        contrastSlider.style.display = 'none';
                    };
                    currentImage.src = event.target.result;
                };

                reader.readAsDataURL(file);
            }
        });

        // Mostrar imagem no preview
        function showImage(img) {
            photoPreview.src = img.src;
            photoPreview.style.display = 'block';
            photoPlaceholder.style.display = 'none';
        }

        // Remover foto
        removePhotoBtn.addEventListener('click', function () {
            photoPreview.src = '';
            photoPreview.style.display = 'none';
            photoPlaceholder.style.display = 'flex';
            editTools.style.display = 'none';
            photoActions.style.display = 'flex';
            brightnessSlider.style.display = 'none';
            contrastSlider.style.display = 'none';
            currentImage = null;
        });

        // Editar foto - abre o modal
        editPhotoBtn.addEventListener('click', function () {
            if (!currentImage) return;

            // Prepara o canvas com a imagem atual
            canvas.width = Math.min(currentImage.width, 600);
            canvas.height = Math.min(currentImage.height, 600);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

            // Salva os dados originais para possível cancelamento
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Mostra o modal
            editModal.style.display = 'flex';
            rotation = 0;
            isCropping = false;
        });

        // Rotacionar para esquerda
        rotateLeftBtn.addEventListener('click', function () {
            rotation -= 90;
            applyTransformations();
        });

        // Rotacionar para direita
        rotateRightBtn.addEventListener('click', function () {
            rotation += 90;
            applyTransformations();
        });

        // Iniciar recorte
        cropBtn.addEventListener('click', function () {
            isCropping = !isCropping;
            cropBtn.textContent = isCropping ? 'Confirmar Recorte' : 'Recortar';

            if (!isCropping && cropStartX && cropStartY && cropEndX && cropEndY) {
                applyCrop();
            }
        });

        // Eventos de mouse para recorte
        canvas.addEventListener('mousedown', function (e) {
            if (!isCropping) return;

            const rect = canvas.getBoundingClientRect();
            cropStartX = e.clientX - rect.left;
            cropStartY = e.clientY - rect.top;
            cropEndX = cropStartX;
            cropEndY = cropStartY;
        });

        canvas.addEventListener('mousemove', function (e) {
            if (!isCropping || !cropStartX) return;

            const rect = canvas.getBoundingClientRect();
            cropEndX = e.clientX - rect.left;
            cropEndY = e.clientY - rect.top;

            // Redesenha a imagem com o retângulo de seleção
            applyTransformations();
            drawCropRectangle();
        });

        canvas.addEventListener('mouseup', function () {
            if (!isCropping) return;

            // Garante que as coordenadas estão na ordem correta
            if (cropStartX > cropEndX) {
                [cropStartX, cropEndX] = [cropEndX, cropStartX];
            }
            if (cropStartY > cropEndY) {
                [cropStartY, cropEndY] = [cropEndY, cropStartY];
            }
        });

        // Desenha o retângulo de seleção para recorte
        function drawCropRectangle() {
            if (!isCropping || !cropStartX) return;

            ctx.strokeStyle = '#ff7c2d';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(cropStartX, cropStartY, cropEndX - cropStartX, cropEndY - cropStartY);
            ctx.setLineDash([]);
        }

        // Aplica o recorte
        function applyCrop() {
            const width = cropEndX - cropStartX;
            const height = cropEndY - cropStartY;

            // Cria um canvas temporário para o recorte
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');

            // Aplica as transformações atuais antes de recortar
            applyTransformations(false);

            // Faz o recorte
            tempCtx.drawImage(canvas, cropStartX, cropStartY, width, height, 0, 0, width, height);

            // Atualiza o canvas principal
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(tempCanvas, 0, 0);

            // Reseta as variáveis de recorte
            cropStartX = cropStartY = cropEndX = cropEndY = null;
            isCropping = false;
            cropBtn.textContent = 'Recortar';
        }

        // Aplica todas as transformações (rotação, brilho, contraste)
        function applyTransformations(drawOriginal = true) {
            if (drawOriginal) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.putImageData(originalImageData, 0, 0);
            }

            // Aplica rotação
            if (rotation !== 0) {
                const angle = rotation * Math.PI / 180;
                const sin = Math.abs(Math.sin(angle));
                const cos = Math.abs(Math.cos(angle));
                const newWidth = canvas.width * cos + canvas.height * sin;
                const newHeight = canvas.width * sin + canvas.height * cos;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = newWidth;
                tempCanvas.height = newHeight;
                const tempCtx = tempCanvas.getContext('2d');

                tempCtx.translate(newWidth / 2, newHeight / 2);
                tempCtx.rotate(angle);
                tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.drawImage(tempCanvas, 0, 0);
            }

            // Aplica brilho e contraste (se estiverem ativos)
            if (brightnessSlider.style.display !== 'none' || contrastSlider.style.display !== 'none') {
                applyImageFilters();
            }

            // Desenha o retângulo de seleção se estiver em modo de recorte
            if (isCropping) {
                drawCropRectangle();
            }
        }

        // Aplica filtros de imagem (brilho e contraste)
        function applyImageFilters() {
            const brightness = parseInt(brightnessInput.value) - 100;
            const contrast = parseInt(contrastInput.value) / 100;

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            const factor = 259 * (255 + contrast) / (255 * (259 - contrast));

            for (let i = 0; i < data.length; i += 4) {
                // Brilho
                data[i] = data[i] + brightness;
                data[i + 1] = data[i + 1] + brightness;
                data[i + 2] = data[i + 2] + brightness;

                // Contraste
                data[i] = factor * (data[i] - 128) + 128;
                data[i + 1] = factor * (data[i + 1] - 128) + 128;
                data[i + 2] = factor * (data[i + 2] - 128) + 128;

                // Garante que os valores estão entre 0 e 255
                data[i] = Math.max(0, Math.min(255, data[i]));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Salvar edições
        saveEditBtn.addEventListener('click', function () {
            // Atualiza a imagem atual com as edições
            currentImage = new Image();
            currentImage.src = canvas.toDataURL('image/png');
            currentImage.onload = function () {
                showImage(this);
                editModal.style.display = 'none';

                // Mostra os controles de brilho/contraste
                brightnessSlider.style.display = 'block';
                contrastSlider.style.display = 'block';
            };
        });

        // Cancelar edições
        cancelEditBtn.addEventListener('click', function () {
            editModal.style.display = 'none';
        });

        // Controles de brilho e contraste
        brightnessInput.addEventListener('input', function () {
            if (!currentImage) return;
            applyImageFiltersToPreview();
        });

        contrastInput.addEventListener('input', function () {
            if (!currentImage) return;
            applyImageFiltersToPreview();
        });

        // Aplica filtros na pré-visualização
        function applyImageFiltersToPreview() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = currentImage.width;
            tempCanvas.height = currentImage.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(currentImage, 0, 0);

            const brightness = parseInt(brightnessInput.value) - 100;
            const contrast = parseInt(contrastInput.value) / 100;

            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;

            const factor = 259 * (255 + contrast) / (255 * (259 - contrast));

            for (let i = 0; i < data.length; i += 4) {
                // Brilho
                data[i] = data[i] + brightness;
                data[i + 1] = data[i + 1] + brightness;
                data[i + 2] = data[i + 2] + brightness;

                // Contraste
                data[i] = factor * (data[i] - 128) + 128;
                data[i + 1] = factor * (data[i + 1] - 128) + 128;
                data[i + 2] = factor * (data[i + 2] - 128) + 128;

                // Garante que os valores estão entre 0 e 255
                data[i] = Math.max(0, Math.min(255, data[i]));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
            }

            tempCtx.putImageData(imageData, 0, 0);
            photoPreview.src = tempCanvas.toDataURL('image/png');
        }

        // Validação do formulário
        document.getElementById('registrationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            let isValid = true;

            // Validações básicas
            const fields = ['firstName', 'lastName', 'age', 'cpf', 'phone', 'email', 'password'];

            fields.forEach(field => {
                const element = document.getElementById(field);
                const errorElement = document.getElementById(`${field}Error`);

                if (!element.value.trim()) {
                    errorElement.textContent = 'Este campo é obrigatório';
                    errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    errorElement.style.display = 'none';
                }
            });

            if (isValid) {
                // Coletar todos os dados do formulário
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    age: document.getElementById('age').value,
                    cpf: document.getElementById('cpf').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    hasPhoto: currentImage !== null,
                    photoData: currentImage ? currentImage.src : null,
                    brightness: brightnessInput.value,
                    contrast: contrastInput.value
                };

                // Exibir no console (F12)
                console.log('Dados do Cadastro:');
                console.log('-----------------');
                console.log('Nome:', formData.firstName, formData.lastName);
                console.log('Idade:', formData.age);
                console.log('CPF:', formData.cpf);
                console.log('Telefone:', formData.phone);
                console.log('Email:', formData.email);
                console.log('Senha:', formData.password);
                console.log('Possui foto:', formData.hasPhoto ? 'Sim' : 'Não');
                if (formData.hasPhoto) {
                    console.log('Foto (base64):', formData.photoData.substring(0, 50) + '...');
                    console.log('Ajustes - Brilho:', formData.brightness, 'Contraste:', formData.contrast);
                }
                console.log('-----------------');
                console.log('Cadastro realizado com sucesso!');

                // Exibir mensagem de sucesso
                alert("Dados salvos com sucesso!");
            }
        });

        // Máscaras para CPF e telefone
        document.getElementById('cpf').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.length > 3) {
                value = value.replace(/^(\d{3})(\d)/g, '$1.$2');
            }
            if (value.length > 6) {
                value = value.replace(/^(\d{3})\.(\d{3})(\d)/g, '$1.$2.$3');
            }
            if (value.length > 9) {
                value = value.replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d)/g, '$1.$2.$3-$4');
            }
            if (value.length > 11) {
                value = value.substring(0, 14);
            }

            e.target.value = value;
        });

        document.getElementById('phone').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.length > 0) {
                value = `(${value.substring(0, 2)}${value.length > 2 ? ') ' + value.substring(2) : ''}`;
            }
            if (value.length > 9) {
                value = `${value.substring(0, 10)}-${value.substring(10)}`;
            }
            if (value.length > 15) {
                value = value.substring(0, 15);
            }

            e.target.value = value;
        });
    </script>
</body>

</html>